
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>TRIP FAST ‚Äî Dispatch</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <style>
    :root{
      --brand:#0ea5ff; /* azul */
      --ink:#eaf2ff;   /* blanco azulado */
      --bg:#0b1220;    /* negro azulado */
      --card:#10192e;  /* panel */
      --muted:#9db3cf; /* texto secundario */
      --ok:#22c55e; --warn:#fbbf24; --no:#ef4444;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth; max-width:100%; overflow-x:hidden;}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#08101f);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;max-width:100%;overflow-x:hidden;}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid #1e2a44;background:#0b1220;position:sticky;top:0;z-index:10}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.6px}
    .logo svg{width:34px;height:34px}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1e2a44;border-radius:18px;padding:16px 16px 12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h2{margin:4px 0 12px 0;font-size:18px;letter-spacing:.3px}
    label{font-size:13px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0c1530;border:1px solid #233355;color:var(--ink);padding:12px 12px;border-radius:12px;font-size:14px}
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-bottom:10px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-8{grid-column:span 8}
    .col-3{grid-column:span 3}.col-12{grid-column:span 12}.col-2{grid-column:span 2}
    .row > *, .grid > * {min-width:0;}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0a1330;border:1px solid #203154;border-radius:999px;padding:8px 12px;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid #2a3d66;background:linear-gradient(180deg,#0e1b38,#0d1a33);padding:10px 14px;border-radius:12px;color:var(--ink);text-decoration:none;cursor:pointer}
    .btn:hover{border-color:#32508e}
    .btn.primary{background:linear-gradient(180deg,#0ea5ff,#0075ff);color:#051027;border-color:transparent;font-weight:700}
    .btn.ghost{background:transparent}
    .actions{display:flex;flex-wrap:wrap;gap:10px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:#1e2a44;margin:12px 0}
    .tag{font-size:11px;opacity:.75}
    .preview{
      white-space:pre-wrap;
      background:#0a1226;
      border:1px dashed #30456f;
      border-radius:12px;
      padding:12px;
      overflow-wrap:anywhere;
      word-break:break-word;
      max-width:100%;
    }
    .note{font-size:12px;color:var(--muted)}
    .footer{font-size:12px;color:var(--muted);text-align:center;margin:18px 0}
    .linkish{color:var(--ink);opacity:.9}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi{background:#0c1630;border:1px solid #22345a;border-radius:12px;padding:10px}
    .kpi b{font-size:18px}
    @media print{
      header,.no-print{display:none !important}
      body{background:white;color:black}
      .card{border:none;box-shadow:none}
      .preview{background:white;border:1px solid #ccc}
    }
    dialog{background:#0c1530;border:1px solid #2a3d66;color:var(--ink);border-radius:14px;max-width:520px}
    .inline-check{display:inline-flex;align-items:center;gap:6px;}
    .inline-check input[type="checkbox"]{margin:0;}
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-label="TRIP FAST">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="g" x1="0" y1="0" x2="64" y2="64" gradientUnits="userSpaceOnUse"><stop stop-color="#0ea5ff"/><stop offset="1" stop-color="#8abfff"/></linearGradient></defs>
        <path d="M8 40h36a10 10 0 0 0 10-10V12" stroke="url(#g)" stroke-width="6" stroke-linecap="round"/>
        <path d="M6 24h26" stroke="#fff" stroke-opacity=".9" stroke-width="4" stroke-linecap="round"/>
        <circle cx="48" cy="48" r="8" stroke="#fff" stroke-opacity=".9" stroke-width="4"/>
      </svg>
      <div>
        <div style="font-size:15px;line-height:1">TRIP FAST</div>
        <div class="tag">Dispatch Console</div>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;align-items:center;gap:10px" class="no-print">
      <button id="btnInstall" class="btn">Install</button>
      <select id="langSel" class="btn">
        <option value="auto">üåê Auto</option>
        <option value="es">ES</option>
        <option value="en">EN</option>
      </select>

      <!-- NUEVO: Login/Logout -->
      <button id="btnLogin" class="btn ghost" data-i18n="btn_login">Login</button>
      <button id="btnLogout" class="btn ghost" style="display:none" data-i18n="btn_logout">Cerrar sesi√≥n</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- === Tu formulario existente (SIN CAMBIOS) === -->
      <section class="card" id="formCard">
        <h2 data-i18n="title_form">Nuevo despacho</h2>
        <div class="row">
          <div class="col-6">
            <label data-i18n="lbl_client">Cliente / Solicitante</label>
            <input id="clientName" data-i18n-placeholder="ph_client_name" placeholder="Nombre y contacto" />
          </div>
          <div class="col-6">
            <label data-i18n="lbl_client_phone">Tel√©fono del cliente</label>
            <input id="clientPhone" placeholder="+593 ‚Ä¶" />
          </div>
          <div class="col-8">
            <label data-i18n="lbl_pick">Punto de recogida (origen)</label>
            <input id="from" data-i18n-placeholder="ph_from" placeholder="direcci√≥n exacta‚Ä¶" />
          </div>
          <div class="col-4">
            <label data-i18n="lbl_pick_time">Hora/Fecha</label>
            <input id="pickupAt" type="datetime-local" />
          </div>
          <div class="col-12">
            <label data-i18n="lbl_drop">Destino</label>
            <input id="to" data-i18n-placeholder="ph_to" placeholder="Direcci√≥n o referencia‚Ä¶" />
          </div>
          <div class="col-6">
            <label data-i18n="lbl_passenger">Pasajero</label>
            <input id="passenger" data-i18n-placeholder="ph_passenger" placeholder="Nombres y apellidos" />
          </div>
          <div class="col-2">
            <label data-i18n="lbl_age">Edad</label>
            <input id="age" type="number" min="0" max="120" />
          </div>
          <div class="col-4">
            <label data-i18n="lbl_companions">Acompa√±antes</label>
            <input id="companions" type="number" min="0" value="0" />
          </div>
          <div class="col-12">
            <label data-i18n="lbl_needs">Necesidades / Accesibilidad</label>
            <div class="row">
              <div class="col-4"><label class="inline-check"><span data-i18n="need_wheel">Silla de ruedas</span><input type="checkbox" id="needWheel"/></label></div>
              <div class="col-4"><label class="inline-check"><span data-i18n="need_bari">Silla bari√°trica</span><input type="checkbox" id="needBari"/></label></div>
              <div class="col-4"><label class="inline-check"><span data-i18n="need_stret">Camilla</span><input type="checkbox" id="needStret"/></label></div>
              <div class="col-4"><label class="inline-check"><span data-i18n="need_oxy">Ox√≠geno</span><input type="checkbox" id="needOxy"/></label></div>
              <div class="col-8"><label class="inline-check"><span data-i18n="need_extra">Requiere personal adicional</span><input type="checkbox" id="needExtra"/></label></div>
            </div>
          </div>
          <div class="col-4">
            <label data-i18n="lbl_floor">Piso destino</label>
            <input id="floor" type="number" min="0" value="0" />
          </div>
          <div class="col-4">
            <label data-i18n="lbl_no_elev">¬øSin ascensor?</label>
            <select id="noElev"><option value="no" selected data-i18n="opt_no">No</option><option value="yes" data-i18n="opt_yes">S√≠</option></select>
          </div>
          <div class="col-4">
            <label data-i18n="lbl_steps"># escalones</label>
            <input id="steps" type="number" min="0" value="0" />
          </div>
          <div class="col-4">
            <label data-i18n="lbl_price">Precio (USD)</label>
            <input id="price" type="number" min="0" step="0.01" />
          </div>
          <div class="col-8">
            <label data-i18n="lbl_notes">Notas</label>
            <input id="notes" data-i18n-placeholder="ph_notes" placeholder="Indicaciones adicionales‚Ä¶" />
          </div>
          <div class="col-12">
            <label data-i18n="lbl_driver">Conductor / Veh√≠culo</label>
            <select id="driverSel"></select>
            <div class="note" id="driverInfo"></div>
          </div>
        </div>
        <div class="actions no-print">
          <button class="btn primary" id="btnPreview" data-i18n="btn_preview">Generar resumen</button>
          <a class="btn" id="btnMap" target="_blank" rel="noopener" data-i18n="btn_map">Abrir mapa</a>
          <button class="btn" id="btnWA">WhatsApp</button>
          <button class="btn" id="btnSMS">SMS</button>
          <button class="btn" id="btnEmail">Email</button>
          <button class="btn ghost" id="btnPrint" data-i18n="btn_print">Imprimir</button>
          <button class="btn ghost" id="btnSetupBackup" data-i18n="btn_setup_backup" title="Elegir archivo para copia auto">Configurar respaldo</button>
          <button class="btn ghost" id="btnBackupNow" data-i18n="btn_backup_now" title="Guardar ahora">Guardar ahora</button>
        </div>
        <div class="hr"></div>
        <div>
          <label class="muted" data-i18n="lbl_preview">Vista previa del mensaje</label>
          <div id="preview" class="preview"></div>
        </div>
      </section>

      <aside class="card">
        <h2 data-i18n="title_fleet">Flota (5 por defecto, editable)</h2>
        <div id="fleetList"></div>
        <div class="hr"></div>
        <div class="kpis">
          <div class="kpi"><div class="muted" data-i18n="kpi_today">Despachos hoy</div><b id="kpiToday">0</b></div>
          <div class="kpi"><div class="muted" data-i18n="kpi_pending">Pendientes</div><b id="kpiPending">0</b></div>
          <div class="kpi"><div class="muted" data-i18n="kpi_drivers">Conductores</div><b id="kpiDrivers">5</b></div>
        </div>
        <div class="hr"></div>
        <button class="btn" id="btnAddDriver" data-i18n="btn_add_driver">A√±adir conductor</button>
        <button class="btn" id="btnResetDrivers" data-i18n="btn_reset_fleet" data-i18n-title="ttl_reset_fleet" title="Volver a los 5 por defecto">Restablecer flota</button>
      </aside>
    </div>
    <div class="footer no-print">¬© <span id="year"></span> TRIP FAST ‚Ä¢ <a class="linkish" href="#" id="openHowTo" data-i18n="lnk_howto">C√≥mo instalar</a></div>
  </div>

  <!-- NUEVO: Vista del Conductor -->
  <section id="driverView" class="wrap" style="display:none">
    <div class="card">
      <h2 data-i18n="title_driver">Conductor</h2>
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <label class="inline-check"><span data-i18n="lbl_available">Disponible</span><input type="checkbox" id="drvAvailable"></label>
        <button class="btn" id="drvRegisterPush" data-i18n="btn_register_push">Activar notificaciones</button>
      </div>
      <div class="hr"></div>
      <div id="driverJobs"></div>
    </div>
  </section>

  <!-- 1) Importa Firebase (m√≥dulo propio) -->
  <script type="module" src="./firebase.js"></script>

  <!-- 2) Tu JS ORIGINAL (id√©ntico) -->
  <script>
    const DICT = {
      es: {
        title_form:"Nuevo despacho", lbl_client:"Cliente / Solicitante", lbl_client_phone:"Tel√©fono del cliente",
        lbl_pick:"Punto de recogida (origen)", lbl_pick_time:"Hora/Fecha", lbl_drop:"Destino",
        lbl_passenger:"Pasajero", lbl_age:"Edad", lbl_companions:"Acompa√±antes", lbl_needs:"Necesidades / Accesibilidad",
        need_wheel:"Silla de ruedas", need_bari:"Silla bari√°trica", need_stret:"Camilla", need_oxy:"Ox√≠geno",
        need_extra:"Requiere personal adicional", lbl_floor:"Piso destino", lbl_no_elev:"¬øSin ascensor?",
        opt_no:"No", opt_yes:"S√≠", lbl_steps:"# escalones", lbl_price:"Precio (USD)", lbl_notes:"Notas",
        lbl_driver:"Conductor / Veh√≠culo", btn_preview:"Generar resumen", btn_map:"Abrir mapa", btn_print:"Imprimir",
        lbl_preview:"Vista previa del mensaje", title_fleet:"Flota (5 por defecto, editable)",
        kpi_today:"Despachos hoy", kpi_pending:"Pendientes", kpi_drivers:"Conductores",
        btn_add_driver:"A√±adir conductor",
        btn_setup_backup:"Configurar respaldo",
        btn_backup_now:"Guardar ahora",

        ph_client_name:"Nombre y contacto",
        ph_from:"Direcci√≥n exacta‚Ä¶",
        ph_to:"Direcci√≥n o referencia‚Ä¶",
        ph_passenger:"Nombres y apellidos",
        ph_notes:"Indicaciones adicionales‚Ä¶",

        btn_reset_fleet:"Restablecer flota",
        ttl_reset_fleet:"Volver a los 5 por defecto",
        btn_delete:"Eliminar",
        lnk_howto:"C√≥mo instalar en iphone/ipad",
        dlg_howto_title:"Instalar en iPhone/iPad",
        dlg_howto_steps:"1) Abre en Safari ¬∑ 2) Toca <b>Compartir</b> ¬∑ 3) <b>A√±adir a pantalla de inicio</b> ¬∑ 4) Confirmar.",
        btn_ok:"OK",

        // NUEVO (i18n extra)
        btn_login:"Iniciar sesi√≥n",
        btn_logout:"Cerrar sesi√≥n",
        title_driver:"Conductor",
        lbl_available:"Disponible",
        btn_register_push:"Activar notificaciones",

        msg_subject:"TRIP FAST ‚Äî Despacho",
        msg_template:(o)=>`Cliente: ${o.clientName} (${o.clientPhone})
Paciente: ${o.passenger} ‚Ä¢ Edad: ${o.age||"-"} ‚Ä¢ Acompa√±antes: ${o.companions}
Origen: ${o.from} 
Destino: ${o.to} 
Fecha/Hora: ${o.pickupAt}
Accesibilidad: ${o.acc}
Edificio: Piso ${o.floor} ‚Ä¢ ${o.noElev==='yes'?'Sin ascensor':'Ascensor'} ‚Ä¢ Escalones: ${o.steps}
Notas: ${o.notes||'-'}
Precio: $${o.price||'-'}

RUTA: ${o.mapUrl}

Asignado a: ${o.driver.name} (${o.driver.vehicle}) ‚Ä¢ ${o.driver.phone}
Placa: ${o.driver.plate}
`,

        dlg_pending_title:"üîî Pendientes",
        pending_none:"No hay pendientes.",
        pending_empty:"(vac√≠o)",
        pending_count_one:"Tienes 1 pendiente.",
        pending_count_many:"Tienes {n} pendientes.",
        btn_pending_clear:"Vaciar todos",
        btn_close:"Cerrar",
        btn_pending_resolve:"Marcar resuelto",
        btn_pending_remove:"Eliminar",
        btn_pending_preview:"Ver resumen",
        confirm_pending_clear:"¬øVaciar todos los pendientes? Esta acci√≥n no se puede deshacer.",
        title_pending_manage:"Ver/gestionar pendientes",
      },
      en: {
        title_form:"New dispatch", lbl_client:"Client / Requester", lbl_client_phone:"Client phone",
        lbl_pick:"Pickup (origin)", lbl_pick_time:"Date/Time", lbl_drop:"Dropoff (destination)",
        lbl_passenger:"Passenger", lbl_age:"Age", lbl_companions:"Companions", lbl_needs:"Needs / Accessibility",
        need_wheel:"Wheelchair", need_bari:"Bariatric chair", need_stret:"Stretcher", need_oxy:"Oxygen",
        need_extra:"Extra staff required", lbl_floor:"Floor", lbl_no_elev:"No elevator?",
        opt_no:"No", opt_yes:"Yes", lbl_steps:"# steps", lbl_price:"Price (USD)", lbl_notes:"Notes",
        lbl_driver:"Driver / Vehicle", btn_preview:"Generate summary", btn_map:"Open map", btn_print:"Print",
        lbl_preview:"Message preview", title_fleet:"Fleet (5 default, editable)",
        kpi_today:"Jobs today", kpi_pending:"Pending", kpi_drivers:"Drivers",
        btn_add_driver:"Add driver",
        btn_setup_backup:"Setup backup",
        btn_backup_now:"Save now",

        ph_client_name:"Name & contact",
        ph_from:"Exact address‚Ä¶",
        ph_to:"Address or reference‚Ä¶",
        ph_passenger:"First and last name",
        ph_notes:"Additional instructions‚Ä¶",

        btn_reset_fleet:"Reset fleet",
        ttl_reset_fleet:"Revert to default 5",
        btn_delete:"Delete",
        lnk_howto:"How to install on iphone/ipad",
        dlg_howto_title:"Install on iPhone/iPad",
        dlg_howto_steps:"1) Open in Safari ¬∑ 2) Tap <b>Share</b> ¬∑ 3) <b>Add to Home Screen</b> ¬∑ 4) Confirm.",
        btn_ok:"OK",

        // NUEVO (i18n extra)
        btn_login:"Login",
        btn_logout:"Logout",
        title_driver:"Driver",
        lbl_available:"Available",
        btn_register_push:"Enable notifications",

        msg_subject:"TRIP FAST ‚Äî Dispatch",
        msg_template:(o)=>`Client: ${o.clientName} (${o.clientPhone})
Passenger: ${o.passenger} ‚Ä¢ Age: ${o.age||"-"} ‚Ä¢ Companions: ${o.companions}
Pickup: ${o.from} 
Dropoff: ${o.to} 
When: ${o.pickupAt}
Accessibility: ${o.acc}
Building: Floor ${o.floor} ‚Ä¢ ${o.noElev==='yes'?'No elevator':'Elevator'} ‚Ä¢ Steps: ${o.steps}
Notes: ${o.notes||'-'}
Price: $${o.price||'-'}

ROUTE: ${o.mapUrl}

Assigned to: ${o.driver.name} (${o.driver.vehicle}) ‚Ä¢ ${o.driver.phone}
Plate: ${o.driver.plate}
`,

        dlg_pending_title:"üîî Pending",
        pending_none:"No pending items.",
        pending_empty:"(empty)",
        pending_count_one:"You have 1 pending item.",
        pending_count_many:"You have {n} pending items.",
        btn_pending_clear:"Clear all",
        btn_close:"Close",
        btn_pending_resolve:"Mark resolved",
        btn_pending_remove:"Delete",
        btn_pending_preview:"View summary",
        confirm_pending_clear:"Clear all pending items? This cannot be undone.",
        title_pending_manage:"View/manage pending",
      }
    };

    function getLang(){
      const forced = localStorage.getItem('tf_lang_forced');
      if(forced && forced !== 'auto') return forced;
      return (navigator.language||'es').toLowerCase().startsWith('es')?'es':'en';
    }

    function applyI18n(){
      const lang = getLang();
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        const txt = DICT[lang][key];
        if(txt != null) el.innerHTML = txt;
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        const txt = DICT[lang][key];
        if(txt != null) el.setAttribute('placeholder', txt);
      });
      document.querySelectorAll('[data-i18n-title]').forEach(el=>{
        const key = el.getAttribute('data-i18n-title');
        const txt = DICT[lang][key];
        if(txt != null) el.setAttribute('title', txt);
      });
    }

    const DEFAULT_DRIVERS = [
      {id:'d1', name:'Luis Beltran', phone:'+593983706294', whatsapp:'+593983706294', email:'donbeltranmusic@gmail.com', vehicle:'Toyota Hiace', plate:'TBA-1234', capacity:4, wheelchair:true},
      {id:'d2', name:'Ana Morales', phone:'+593991112233', whatsapp:'+593991112233', email:'driver02@tripfast.app', vehicle:'Renault Kangoo', plate:'PBC-5678', capacity:3, wheelchair:true},
      {id:'d3', name:'Luis Herrera', phone:'+593972223344', whatsapp:'+593972223344', email:'driver03@tripfast.app', vehicle:'Hyundai H1', plate:'GHY-9012', capacity:4, wheelchair:true},
      {id:'d4', name:'Carla Vega', phone:'+593963334455', whatsapp:'+593963334455', email:'driver04@tripfast.app', vehicle:'Chevrolet N300', plate:'ABC-3456', capacity:3, wheelchair:false},
      {id:'d5', name:'Diego Su√°rez', phone:'+593954445566', whatsapp:'+593954445566', email:'driver05@tripfast.app', vehicle:'Ford Transit', plate:'DEF-7890', capacity:6, wheelchair:true},
    ];
    function loadFleet(){
      const fromLS = localStorage.getItem('tf_fleet');
      return fromLS? JSON.parse(fromLS) : DEFAULT_DRIVERS;
    }
    function saveFleet(list){ localStorage.setItem('tf_fleet', JSON.stringify(list)); }

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const yearEl = $('#year'); yearEl.textContent = new Date().getFullYear();

    let fleet = loadFleet();

    function getIntLS(key){ return parseInt(localStorage.getItem(key)||'0',10); }
    function setKPI(id, n){
      document.getElementById(id).textContent = String(n);
      if(id==='kpiToday') localStorage.setItem('tf_today', n);
      if(id==='kpiPending') localStorage.setItem('tf_pending', n);
    }
    function incToday(){ setKPI('kpiToday', getIntLS('tf_today') + 1); }

    const PENDING_KEY = 'tf_pending_list';
    function getPendingList(){
      try { return JSON.parse(localStorage.getItem(PENDING_KEY) || '[]'); }
      catch { return []; }
    }
    function setPendingList(list){
      localStorage.setItem(PENDING_KEY, JSON.stringify(list));
    }
    function incPending(){
      setKPI('kpiPending', getIntLS('tf_pending') + 1);
      const data = collect();
      const item = {
        id: 'p' + Date.now(),
        when: Date.now(),
        client: data.clientName || '(Sin cliente)',
        passenger: data.passenger || '(Sin Pasajero)',
        from: data.from || '',
        to: data.to || '',
        driver: data?.driver?.name || '',
        price: data.price || '',
        preview: DICT[getLang()].msg_template(data)
      };
      const list = getPendingList();
      list.push(item);
      setPendingList(list);
    }
    function decPending(){
      const cur = Math.max(0, getIntLS('tf_pending') - 1);
      setKPI('kpiPending', cur);
      const list = getPendingList();
      list.shift(); // FIFO
      setPendingList(list);
    }

    function paintFleet(){
      $('#kpiDrivers').textContent = fleet.length;
      const driverSel = $('#driverSel'); driverSel.innerHTML='';
      fleet.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = `${d.name} ‚Ä¢ ${d.vehicle} ‚Ä¢ ${d.plate}`;
        driverSel.appendChild(opt);
      });

      const lang = getLang();
      const list = document.getElementById('fleetList');
      list.innerHTML = fleet.map(d=>`
        <div class="pill" style="margin:4px 6px 6px 0;display:flex;justify-content:space-between;align-items:center;width:100%">
          <span>üöó <b>${d.name}</b> ¬∑ ${d.vehicle} ¬∑ ${d.plate} ¬∑ <span class="muted">${d.phone}</span></span>
          <button class="btn ghost" data-del="${d.id}" style="padding:6px 10px">${DICT[lang].btn_delete}</button>
        </div>`).join('');
      updateDriverInfo();
    }
    function findDriver(id){ return fleet.find(d=>d.id===id) || fleet[0]; }
    function updateDriverInfo(){
      const d = findDriver($('#driverSel').value);
      const lang=getLang();
      $('#driverInfo').textContent = lang==='es'
        ? `Cel: ${d.phone} ¬∑ WhatsApp: ${d.whatsapp} ¬∑ Email: ${d.email}`
        : `Phone: ${d.phone} ¬∑ WhatsApp: ${d.whatsapp} ¬∑ Email: ${d.email}`;
    }

    function buildMapUrl(pickup, destination){
      const enc = encodeURIComponent;
      const base = "https://www.google.com/maps/dir/?api=1";
      const destParam = `destination=${enc(destination)}`;
      const wpParam = `waypoints=${enc(pickup)}`;
      const modeParam = `travelmode=driving`;
      const actionParam = `dir_action=navigate`;
      return `${base}&${destParam}&${wpParam}&${modeParam}&${actionParam}`;
    }

    function accSummary(){
      const lang=getLang();
      const items=[];
      if($('#needWheel').checked) items.push(lang==='es'? 'Silla ruedas':'Wheelchair');
      if($('#needBari').checked) items.push(lang==='es'? 'Bari√°trica':'Bariatric');
      if($('#needStret').checked) items.push(lang==='es'? 'Camilla':'Stretcher');
      if($('#needOxy').checked) items.push(lang==='es'? 'Ox√≠geno':'Oxygen');
      if($('#needExtra').checked) items.push(lang==='es'? 'Extra personal':'Extra staff');
      return items.length? items.join(', ') : (lang==='es'?'N/A':'N/A');
    }
    function collect(){
      const driver = findDriver($('#driverSel').value);
      const from = $('#from').value.trim();
      const to = $('#to').value.trim();
      const mapUrl = (from && to) ? buildMapUrl(from, to) : '';
      const lang=getLang();
      const pickupAt = $('#pickupAt').value ? new Date($('#pickupAt').value).toLocaleString(lang==='es'?'es-EC':'en-US') : '-';
      const obj = {
        clientName: $('#clientName').value.trim(),
        clientPhone: $('#clientPhone').value.trim(),
        from, to, pickupAt,
        passenger: $('#passenger').value.trim(),
        age: $('#age').value.trim(),
        companions: $('#companions').value.trim() || '0',
        acc: accSummary(),
        floor: $('#floor').value.trim() || '0',
        noElev: $('#noElev').value,
        steps: $('#steps').value.trim() || '0',
        price: $('#price').value.trim(),
        notes: $('#notes').value.trim(),
        driver, mapUrl
      };
      return obj;
    }
    function preview(){
      const lang=getLang();
      const data=collect();
      const msg = DICT[lang].msg_template(data);
      $('#preview').textContent = msg;
      return {msg, data};
    }
    function ensurePreview(){ if(!$('#preview').textContent) return preview(); }

    $('#driverSel').addEventListener('change', updateDriverInfo);
    $('#btnPreview').addEventListener('click', ()=>{
      preview();
      incToday();
      incPending();
    });

    $('#btnMap').addEventListener('click', ()=>{
      const {data}=preview();
      if(!data.mapUrl){ alert(getLang()==='es'? 'Completa origen y destino':'Fill origin and destination'); return; }
      $('#btnMap').href = data.mapUrl;
    });

    $('#btnPrint').addEventListener('click', ()=>{
      ensurePreview();
      window.print();
      decPending();
    });

    function openLink(u){ window.open(u, '_blank', 'noopener'); }
    function sendWhats(){
      const {msg,data}=preview();
      const num = (data.driver.whatsapp||'').replace(/\D/g,'');
      if(!num) return alert('No WhatsApp');
      openLink(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`);
      decPending();
    }
    function sendSMS(){
      const {msg,data}=preview();
      const num = data.driver.phone || '';
      if(!num) return alert('No phone');
      const body = encodeURIComponent(msg);
      const url = navigator.userAgent.match(/(iPhone|iPad)/) ? `sms:${num}&body=${body}` : `sms:${num}?body=${body}`;
      window.location.href = url;
      decPending();
    }
    function sendEmail(){
      const {msg,data}=preview();
      const lang=getLang();
      const subject = encodeURIComponent(DICT[lang].msg_subject);
      const body = encodeURIComponent(msg);
      openLink(`mailto:${data.driver.email}?subject=${subject}&body=${body}`);
      decPending();
    }
    $('#btnWA').addEventListener('click', sendWhats);
    $('#btnSMS').addEventListener('click', sendSMS);
    $('#btnEmail').addEventListener('click', sendEmail);

    $('#btnAddDriver').addEventListener('click', ()=>{
      const name = prompt('Nombre del conductor'); if(!name) return;
      const phone = prompt('Tel√©fono (E.164, ej +593...)')||'';
      const email = prompt('Email')||'';
      const vehicle = prompt('Veh√≠culo/Modelo')||'';
      const plate = prompt('Placa')||'';
      const whatsapp = prompt('WhatsApp (E.164, ej +593...)')||phone;
      const d = {id: 'd'+(Date.now()), name, phone, email, vehicle, plate, whatsapp, capacity:4, wheelchair:true};
      fleet.push(d); saveFleet(fleet); paintFleet();
    });

    function deleteDriver(id){
      const d = fleet.find(x=>x.id===id);
      if(!d) return;
      const lang = getLang();
      const ok = confirm(lang==='es' ? `¬øEliminar a ${d.name}?` : `Delete ${d.name}?`);
      if(!ok) return;
      fleet = fleet.filter(x=>x.id!==id);
      saveFleet(fleet);
      paintFleet();
    }

    document.getElementById('fleetList').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-del]');
      if(!btn) return;
      deleteDriver(btn.getAttribute('data-del'));
    });

    document.getElementById('btnResetDrivers').addEventListener('click', ()=>{
      const lang = getLang();
      const ok = confirm(lang==='es'
        ? 'Esto reemplazar√° la flota actual por la flota por defecto. ¬øContinuar?'
        : 'This will replace the current fleet with the default fleet. Continue?');
      if(!ok) return;
      fleet = JSON.parse(JSON.stringify(DEFAULT_DRIVERS));
      saveFleet(fleet);
      paintFleet();
    });

    setKPI('kpiToday', getIntLS('tf_today'));
    setKPI('kpiPending', getIntLS('tf_pending'));

    function getLangForced(){ return localStorage.getItem('tf_lang_forced')||'auto'; }
    function setLangForced(v){ localStorage.setItem('tf_lang_forced', v); }
    applyI18n();
    const sel=$('#langSel'); sel.value=getLangForced();
    sel.addEventListener('change',()=>{ setLangForced(sel.value); applyI18n(); preview(); paintFleet(); });

    document.getElementById('openHowTo').addEventListener('click',(e)=>{
      e.preventDefault(); 
      document.getElementById('howTo').showModal();
    });

    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('./sw.js?v=tripfast-v8').then(()=>{
          const pill = document.getElementById('statusPWA');
          if (pill) pill.classList.add('ok');
        }).catch(()=>{});
      })
    }

    (function setupInstallBubble(){
      const installBtn = document.getElementById('btnInstall');
      let deferredPrompt = null;
      function isStandalone(){
        return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      }
      function refreshInstallVisibility(){
        installBtn.style.display = isStandalone() ? 'none' : 'inline-flex';
      }
      refreshInstallVisibility();

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        refreshInstallVisibility();

        installBtn.onclick = async () => {
          if(!deferredPrompt) return;
          installBtn.disabled = true;
          try{
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              installBtn.style.display = 'none';
            }
          } finally {
            installBtn.disabled = false;
            deferredPrompt = null;
          }
        };
      });

      window.addEventListener('appinstalled', () => {
        installBtn.style.display = 'none';
        deferredPrompt = null;
      });

      document.addEventListener('visibilitychange', refreshInstallVisibility);
    })();

    (function setupPendingManager(){
      const dlg = document.getElementById('pendingDlg');
      const listEl = document.getElementById('pendingList');
      const infoEl = document.getElementById('pendingInfo');
      const btnClear = document.getElementById('btnPendingClear');
      const btnClose = document.getElementById('btnPendingClose');

      const pendingCard = document.querySelector('.kpis .kpi:nth-child(2)');
      function setManageTitle(){
        pendingCard.title = DICT[getLang()].title_pending_manage;
      }
      if (pendingCard) {
        pendingCard.style.cursor = 'pointer';
        setManageTitle();
        pendingCard.addEventListener('click', () => {
          renderPending();
          dlg.showModal();
        });
      }

      function renderPending(){
        const lang = getLang();
        const T = DICT[lang];
        const list = getPendingList();

        if (!list.length){
          infoEl.textContent = T.pending_none;
        } else if (list.length === 1){
          infoEl.textContent = T.pending_count_one;
        } else {
          infoEl.textContent = T.pending_count_many.replace('{n}', String(list.length));
        }

        if (!list.length){
          listEl.textContent = T.pending_empty;
          return;
        }

        listEl.innerHTML = list.map(it => {
          const fecha = new Date(it.when).toLocaleString(lang==='es'?'es-EC':'en-US');
          return `
<div style="border-bottom:1px dashed #30456f; padding:8px 0">
  <div><b>${it.client}</b> ‚Äî ${it.passenger}</div>
  <div class="muted" style="font-size:12px">${fecha} ‚Ä¢ ${it.from} ‚Üí ${it.to} ‚Ä¢ ${it.driver || '‚Äî'}</div>
  <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
    <button class="btn" data-resolve="${it.id}">${T.btn_pending_resolve}</button>
    <button class="btn ghost" data-remove="${it.id}">${T.btn_pending_remove}</button>
    <button class="btn ghost" data-preview="${it.id}">${T.btn_pending_preview}</button>
  </div>
</div>`;
        }).join('');
      }

      listEl.addEventListener('click', (e)=>{
        const btnResolve = e.target.closest('button[data-resolve]');
        const btnRemove  = e.target.closest('button[data-remove]');
        const btnPrev    = e.target.closest('button[data-preview]');
        if (!btnResolve && !btnRemove && !btnPrev) return;

        let list = getPendingList();

        if (btnPrev){
          const id = btnPrev.getAttribute('data-preview');
          const item = list.find(x=>x.id===id);
          if (item) alert(item.preview);
          return;
        }

        if (btnResolve){
          const id = btnResolve.getAttribute('data-resolve');
          list = list.filter(x=>x.id!==id);
          setPendingList(list);
          setKPI('kpiPending', list.length);
          renderPending();
          return;
        }

        if (btnRemove){
          const id = btnRemove.getAttribute('data-remove');
          list = list.filter(x=>x.id!==id);
          setPendingList(list);
          setKPI('kpiPending', list.length);
          renderPending();
          return;
        }
      });

      btnClear.addEventListener('click', (e)=>{
        e.preventDefault();
        const T = DICT[getLang()];
        if (confirm(T.confirm_pending_clear)){
          setPendingList([]);
          setKPI('kpiPending', 0);
          renderPending();
        }
      });

      btnClose.addEventListener('click', (e)=>{
        e.preventDefault();
        dlg.close();
      });

      document.getElementById('langSel').addEventListener('change', setManageTitle);
    })();

    let backupFileHandle = null;
    async function setupBackup(){
      if(!window.showSaveFilePicker){
        alert('Tu navegador no soporta copia autom√°tica.\nUsa Export/Import manual.');
        return;
      }
      try{
        backupFileHandle = await window.showSaveFilePicker({
          suggestedName: 'tripfast-backup.json',
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
        });
        await writeFullBackup();
        alert('Respaldo configurado ‚úîÔ∏è. Guardaremos los cambios autom√°ticamente.');
      }catch(err){}
    }
    async function writeFile(handle, contents){
      const writable = await handle.createWritable();
      await writable.write(contents);
      await writable.close();
    }
    async function writeFullBackup(){
      if(!backupFileHandle) return;
      const dump = { fleet, lastForm: collect(), ts: Date.now() };
      try{ await writeFile(backupFileHandle, JSON.stringify(dump,null,2)); }catch(e){}
    }
    const _saveFleetOrig = saveFleet;
    saveFleet = function(list){ _saveFleetOrig(list); writeFullBackup(); };

    document.getElementById('btnSetupBackup').addEventListener('click', setupBackup);
    document.getElementById('btnBackupNow').addEventListener('click', ()=>writeFullBackup());

    paintFleet(); preview();
  </script>

  <!-- 3) M√≥dulo NUEVO: crea Job en Firestore + Vista Driver + Login/Logout -->
  <script type="module">
    import { createJob, onAuth, login, logout, setupMessagingForDriver, listenDriverJobs, updateJobStatus } from './firebase.js';

    function attachJobCreator(){
      const btn = document.getElementById('btnPreview');
      if(!btn || btn.__tfJobAttached) return;
      btn.__tfJobAttached = true;
      btn.addEventListener('click', async ()=>{
        try{
          if (typeof preview !== 'function') return;
          const { data } = preview();
          const job = {
            client: data.clientName || '',
            client_phone: data.clientPhone || '',
            from: data.from || '',
            to: data.to || '',
            pickup_at: data.pickupAt || '',
            passenger: data.passenger || '',
            age: data.age || null,
            companions: data.companions || 0,
            acc: data.acc || '',
            floor: data.floor || '0',
            no_elev: data.noElev || 'no',
            steps: data.steps || '0',
            price: data.price || null,
            notes: data.notes || '',
            map_url: data.mapUrl || '',
            driver_id: (data.driver && data.driver.id) ? data.driver.id : (typeof findDriver==='function' ? findDriver(document.getElementById('driverSel').value).id : null)
          };
          await createJob(job);
        }catch(err){
          const es = (typeof getLang==='function' ? getLang() : 'es') === 'es';
          alert(es ? 'Inicia sesi√≥n (bot√≥n Login) para enviar el despacho al conductor.'
                   : 'Please sign in (Login button) to send the job to the driver.');
          console.warn('[TripFast] createJob failed:', err);
        }
      }, { passive:true });
    }
    window.addEventListener('load', attachJobCreator);
    setTimeout(attachJobCreator, 800);

    const drvSection  = document.getElementById('driverView');
    const consoleGrid = document.querySelector('.grid');
    const btnLogin    = document.getElementById('btnLogin');
    const btnLogout   = document.getElementById('btnLogout');
    const listEl      = document.getElementById('driverJobs');
    const btnPush     = document.getElementById('drvRegisterPush');

    function showDriverView(show){
      if(!drvSection || !consoleGrid) return;
      drvSection.style.display = show ? 'block' : 'none';
      consoleGrid.style.display = show ? 'none' : 'grid';
    }
    function renderJobs(items){
      const lang = (typeof getLang==='function' ? getLang() : 'es');
      if (!listEl) return;
      listEl.innerHTML = items.map(j => `
        <div class="card" style="margin:10px 0">
          <div><b>${j.passenger || '-'}</b> ‚Äî $${j.price || '-'} ‚Ä¢ <span class="muted">${j.status}</span></div>
          <div class="muted" style="font-size:12px">${j.from} ‚Üí ${j.to}</div>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            <a class="btn" href="${j.map_url}" target="_blank" rel="noopener">${lang==='es'?'Navegar':'Navigate'}</a>
            ${j.status==='sent' ? `<button class="btn" data-acc="${j.id}">${lang==='es'?'Aceptar':'Accept'}</button>` : ''}
            ${j.status==='sent' ? `<button class="btn ghost" data-rej="${j.id}">${lang==='es'?'Rechazar':'Reject'}</button>` : ''}
            ${j.status==='accepted' ? `<button class="btn" data-onr="${j.id}">${lang==='es'?'En ruta':'On route'}</button>` : ''}
            ${j.status==='onroute' ? `<button class="btn" data-arr="${j.id}">${lang==='es'?'Llegu√©':'Arrived'}</button>` : ''}
            ${j.status==='arrived' ? `<button class="btn" data-abo="${j.id}">${lang==='es'?'A bordo':'Aboard'}</button>` : ''}
            ${j.status==='aboard' ? `<button class="btn" data-done="${j.id}">${lang==='es'?'Finalizar':'Done'}</button>` : ''}
          </div>
        </div>`).join('');
    }
    if (listEl){
      listEl.addEventListener('click', async (e)=>{
        const el = e.target;
        const id = el.getAttribute('data-acc') || el.getAttribute('data-rej') || el.getAttribute('data-onr') || el.getAttribute('data-arr') || el.getAttribute('data-abo') || el.getAttribute('data-done');
        if(!id) return;
        const map = { acc:'accepted', rej:'rejected', onr:'onroute', arr:'arrived', abo:'aboard', done:'done' };
        const code = el.hasAttribute('data-acc') ? 'acc' :
                     el.hasAttribute('data-rej') ? 'rej' :
                     el.hasAttribute('data-onr') ? 'onr' :
                     el.hasAttribute('data-arr') ? 'arr' :
                     el.hasAttribute('data-abo') ? 'abo' : 'done';
        try{ await updateJobStatus(id, map[code], 'driver'); }catch(err){ console.warn(err); }
      });
    }

    onAuth(async (user)=>{
      if(!user){
        if (btnLogin) btnLogin.style.display = 'inline-flex';
        if (btnLogout) btnLogout.style.display = 'none';
        showDriverView(false);
        return;
      }
      const token = await user.getIdTokenResult(true);
      const role = token.claims.role;
      const driverId = token.claims.driver_id;
      if (btnLogin) btnLogin.style.display = 'none';
      if (btnLogout) btnLogout.style.display = 'inline-flex';
      if(role === 'driver'){
        showDriverView(true);
        if (btnPush) btnPush.onclick = ()=>setupMessagingForDriver(driverId);
        listenDriverJobs(driverId, renderJobs);
      } else {
        showDriverView(false);
      }
    });

    if (btnLogin){
      btnLogin.addEventListener('click', async()=>{
        const email = prompt('Email'); if(!email) return;
        const pass  = prompt((typeof getLang==='function' && getLang()==='es')?'Contrase√±a':'Password'); if(!pass) return;
        try{ await login(email, pass); }catch(err){ alert(err.message || String(err)); }
      });
    }
    if (btnLogout){ btnLogout.addEventListener('click', ()=>logout()); }
  </script>

  <!-- Di√°logos existentes (instalaci√≥n y pendientes) -->
  <dialog id="howTo">
    <form method="dialog" style="margin:0">
      <div style="padding:16px 16px 4px"><b data-i18n="dlg_howto_title">Instalar en iPhone/iPad</b></div>
      <div style="padding:0 16px 12px" class="muted" data-i18n="dlg_howto_steps">
        1) Abre en Safari ¬∑ 2) Toca <b>Compartir</b> ¬∑ 3) <b>A√±adir a pantalla de inicio</b> ¬∑ 4) Confirmar.
      </div>
      <div style="display:flex;justify-content:flex-end;padding:0 12px 12px"><button class="btn" data-i18n="btn_ok">OK</button></div>
    </form>
  </dialog>

  <dialog id="pendingDlg">
    <form method="dialog" style="margin:0; max-width:720px">
      <div style="padding:16px 16px 4px">
        <b id="pendingTitle" data-i18n="dlg_pending_title">üîî Pendientes</b>
        <div class="muted" id="pendingInfo" style="margin-top:6px"></div>
      </div>
      <div style="padding:0 16px 12px">
        <div id="pendingList" class="preview" style="max-height:45vh; overflow:auto"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;padding:0 12px 12px">
        <button class="btn ghost" id="btnPendingClear" data-i18n="btn_pending_clear">Vaciar todos</button>
        <button class="btn" id="btnPendingClose" data-i18n="btn_close">Cerrar</button>
      </div>
    </form>
  </dialog>
</body>
</html>




         







